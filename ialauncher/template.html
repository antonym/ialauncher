<!doctype html>
<html>
  <head>
    <title>DOS Games</title>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" href="favicon.png">
    <style>
      button {
          width: {{initial_grid}}vw;
          height: {{initial_grid}}vh;
      }
      body, html {
          margin: 0;
          padding: 0;
          background: black;
      }
      body::-webkit-scrollbar {
          display: none;
      }

      button {
          outline: none;
          background: black;
          opacity: 0.5;
          float: left;
          padding: 0;
          margin: 0;
          display: block;
          color: white;
          position: relative;
          box-sizing: border-box;
          border: 10px solid black;
      }

      button:focus {
          opacity: 1;
          border: none;
      }

      img {
          {% if aspect %}
            object-fit: contain;
          {% endif %}
          display: block;
          image-rendering: crisp-edges;
          width: 100%;
          height: 100%;
      }

    </style>
  </head>
  <body>
    {% for game in games %}
      <button data-url="{{game.urlencoded()}}" data-title="{{game.title}}" tabindex="0">
        <img src="{{game.urlencoded()}}/title.png" draggable="false">
      </button>
    {% endfor %}
    <script>
      function get(game, action) {
          var x = new XMLHttpRequest();
          x.open('GET', '\\' + game.dataset.url + '/' + action, true);
          x.send();
      }

      document.addEventListener('DOMContentLoaded', function(event) {
          var games = document.querySelectorAll('button');
          games[0].focus();

          function focus_random_game() {
              var game = games[Math.floor(Math.random()*games.length)];
              game.focus();
          }
          {% if slideshow %}
          setInterval(focus_random_game, {{slideshow}});
          {% endif %}

          function handle_keydown(e) {
              if (e.altKey && e.keyCode == 13) {
                  e.preventDefault();
                  get(document.activeElement, 'edit');
                  return;
              }

              switch (e.keyCode) {
                  case 13: // enter key
                      e.preventDefault();
                      get(document.activeElement, 'start');
                      break;

                  case 33: // page up
                      e.preventDefault();
                      break;

                  case 34: // page down
                      e.preventDefault();
                      break;

                  case 37: // left arrow
                      e.preventDefault();
                      i = [].indexOf.call(games, document.activeElement);
                      if (i != 0) i--;
                      games[i].focus();
                      break;

                  case 38: // up arrow
                      e.preventDefault();
                      i = [].indexOf.call(games, document.activeElement);
                      do {
                          if (i == 0) break;
                          i--;
                      }
                      while (games[i].getBoundingClientRect().left != document.activeElement.getBoundingClientRect().left);
                      games[i].focus();
                      break;

                  case 39: // right arrow
                      e.preventDefault();
                      i = [].indexOf.call(games, document.activeElement);
                      if (i != games.length - 1) i++;
                      games[i].focus();
                      break;

                  case 40: // down arrow
                      e.preventDefault();
                      i = [].indexOf.call(games, document.activeElement);
                      do {
                          if (i == games.length - 1) break;
                          i++;
                      }
                      while (games[i].getBoundingClientRect().left != document.activeElement.getBoundingClientRect().left);
                      games[i].focus();
                      break;
              }
          }

          current_zoom_level = 25
          function handle_keypress(e) {
              if (e.ctrlKey) {
                  return;
              }
              if (e.key == '-') {
                  old_value = document.styleSheets[0].cssRules[0].style.getPropertyValue('width').replace('vw', '');
                  new_value = Math.min(100, 100 / (100 / old_value + 1));
                  document.styleSheets[0].cssRules[0].style.setProperty('width', new_value + 'vw');
                  document.styleSheets[0].cssRules[0].style.setProperty('height', new_value + 'vh');
                  document.activeElement.scrollIntoView();
              }
              if (e.key == '=') {
                  old_value = document.styleSheets[0].cssRules[0].style.getPropertyValue('width').replace('vw', '');
                  new_value = Math.min(100, 100 / (100 / old_value - 1));
                  document.styleSheets[0].cssRules[0].style.setProperty('width', new_value + 'vw');
                  document.styleSheets[0].cssRules[0].style.setProperty('height', new_value + 'vh');
                  document.activeElement.scrollIntoView();
              }
              if (/^[a-z0-9]$/.exec(e.key)) {
                  for (let game of games) {
                      if (game.dataset.title.toLowerCase()[0] == e.key) {
                          game.focus();
                          game.scrollIntoView();
                          break;
                      }
                  }
              }
          }

          function handle_wheel(e) {
              e.preventDefault()
          }
          document.addEventListener("keydown", handle_keydown);
          document.addEventListener("keypress", handle_keypress);
          document.addEventListener("wheel", handle_wheel);
      });
    </script>
  </body>
</html>
